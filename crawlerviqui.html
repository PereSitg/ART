<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Importador de Biografies a Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white p-10">
    <div class="max-w-2xl mx-auto bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-2xl">
        <h1 class="text-2xl font-bold mb-6 text-blue-400 italic">SitgesArt - Importador CSV</h1>
        
        <p class="text-sm text-slate-400 mb-6">Selecciona el fitxer <code class="text-blue-300">biografies_completes_sitges.csv</code> per pujar-lo a la base de dades.</p>
        
        <input type="file" id="csvFile" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500 mb-6 cursor-pointer">
        
        <button onclick="processarCSV()" id="btn-pujar" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold transition-all shadow-lg shadow-emerald-900/20">üöÄ PUJAR A FIREBASE</button>
        
        <div id="log" class="mt-6 p-4 bg-black rounded-lg h-48 overflow-y-auto font-mono text-xs text-emerald-500 border border-slate-800">
            > Esperant fitxer...
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const config = { apiKey: "AIzaSyAV8SrQ3tDiixCRwUDgC33jI8ZJzlcceZc", authDomain: "sitgesart.firebaseapp.com", projectId: "sitgesart", storageBucket: "sitgesart.firebasestorage.app", appId: "1:673959867307:web:80607c11d79db42b4918ee" };
        const app = getApps().length === 0 ? initializeApp(config) : getApp();
        const db = getFirestore(app);

        window.processarCSV = async () => {
            const fileInput = document.getElementById('csvFile');
            const logBox = document.getElementById('log');
            if (!fileInput.files[0]) return alert("Selecciona un fitxer primer!");

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split("\n").slice(1); // Treiem la cap√ßalera
                logBox.innerHTML = "> Iniciant importaci√≥ massiva...\n";

                let pujats = 0;
                for (let line of lines) {
                    if (!line.trim()) continue;
                    
                    // Neteja simple de les columnes del CSV (delimitat per ;)
                    const caps = line.match(/"([^"]*)"/g).map(c => c.replace(/"/g, ''));
                    const [font, nom, resum, link, origen] = caps;

                    try {
                        // Comprovem si ja existeix per no duplicar
                        const q = query(collection(db, "obres"), where("nom", "==", nom));
                        const snap = await getDocs(q);

                        if (snap.empty) {
                            await addDoc(collection(db, "obres"), {
                                font: font,
                                nom: nom,
                                resum: resum,
                                link: link,
                                origen: origen,
                                data_creacio: new Date().toISOString()
                            });
                            pujats++;
                            logBox.innerHTML += `<div>‚úÖ Pujat: ${nom}</div>`;
                        } else {
                            logBox.innerHTML += `<div class="text-slate-500">skipping: ${nom} (ja existeix)</div>`;
                        }
                        logBox.scrollTop = logBox.scrollHeight;
                    } catch (err) {
                        logBox.innerHTML += `<div class="text-red-500">‚ùå ERROR: Quota superada o error de xarxa.</div>`;
                        break;
                    }
                }
                logBox.innerHTML += `<div class="text-blue-400 font-bold mt-2">> PROC√âS ACABAT. ${pujats} biografies noves.</div>`;
            };
            reader.readAsText(fileInput.files[0]);
        };
    </script>
</body>
</html>
