<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Super-Monitor Biografies Sitges</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; padding: 2rem; }
        .stats-card { background: #1e293b; border-radius: 1rem; padding: 1.5rem; border: 1px solid #334155; }
        .progress-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.3s; }
        .log-box { background: #020617; border-radius: 0.5rem; height: 350px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; padding: 1rem; border: 1px solid #334155; }
    </style>
</head>
<body>

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black text-white">üì° Super-Scanner Sitges</h1>
                <p class="text-slate-400">Recerca profunda: Sitgetans, Artistes i Personatges hist√≤rics</p>
            </div>
            <div class="space-x-2">
                <button onclick="iniciarCercaProfunda()" id="btn-start" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold transition">üî• INICIAR ESCANEIG TOTAL</button>
                <button onclick="descarregarCSV()" id="btn-csv" class="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-xl font-bold hidden">üì• BAIXAR CSV</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="stats-card">
                <p class="text-slate-400 text-sm uppercase font-bold">Personatges Trobats</p>
                <p id="total-found" class="text-4xl font-black">0</p>
            </div>
            <div class="stats-card">
                <p class="text-slate-400 text-sm uppercase font-bold">Dades Descarregades</p>
                <p id="total-done" class="text-4xl font-black text-blue-400">0</p>
            </div>
            <div class="stats-card">
                <p class="text-slate-400 text-sm uppercase font-bold">Progr√©s</p>
                <div class="mt-2 h-3 bg-slate-700 rounded-full overflow-hidden"><div id="progress" class="progress-fill"></div></div>
                <p id="percent" class="text-right text-xs mt-1 text-slate-500">0%</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div id="log" class="log-box text-slate-300">
                <div>> Esperant per escanejar m√∫ltiples categories...</div>
            </div>
            <div id="preview" class="bg-slate-800 p-8 rounded-2xl border-2 border-dashed border-slate-700 flex flex-col justify-center min-h-[300px]">
                <p class="text-center text-slate-500">Aqu√≠ veur√†s en Rusi√±ol, en Casas i els altres a mesura que surtin.</p>
            </div>
        </div>
    </div>

    <script>
        let resultats = [];

        async function iniciarCercaProfunda() {
            document.getElementById('btn-start').disabled = true;
            const logBox = document.getElementById('log');
            logBox.innerHTML = "";
            
            // Categories a escanejar
            const categories = [
                'Category:Sitgetans',
                'Category:Artistes_de_Sitges',
                'Category:Alcaldes_de_Sitges',
                'Category:Escriptors_de_Sitges'
            ];

            let llistaNoms = new Set(); // Evitem duplicats

            for (const cat of categories) {
                logBox.innerHTML += `<div class="text-blue-400">> Escanejant ${cat}...</div>`;
                const url = `https://ca.wikipedia.org/w/api.php?action=query&list=categorymembers&cmtitle=${cat}&cmlimit=200&format=json&origin=*`;
                const r = await fetch(url);
                const d = await r.json();
                if (d.query && d.query.categorymembers) {
                    d.query.categorymembers.forEach(m => { if (m.ns === 0) llistaNoms.add(m.title); });
                }
            }

            const noms = Array.from(llistaNoms);
            document.getElementById('total-found').innerText = noms.length;
            logBox.innerHTML += `<div class="text-yellow-400 font-bold">> Total √∫nic trobat: ${noms.length} personatges.</div>`;

            let i = 0;
            for (const nom of noms) {
                i++;
                document.getElementById('total-done').innerText = i;
                const pct = Math.round((i / noms.length) * 100);
                document.getElementById('progress').style.width = pct + "%";
                document.getElementById('percent').innerText = pct + "%";

                const d = await extreureDades(nom);
                resultats.push(d);
                actualitzarTargeta(d);
                logBox.innerHTML += `<div>Descarregat: ${nom}</div>`;
                logBox.scrollTop = logBox.scrollHeight;
            }

            document.getElementById('btn-csv').classList.remove('hidden');
        }

        async function extreureDades(titol) {
            const url = `https://ca.wikipedia.org/w/api.php?action=query&prop=extracts|info&exintro&explaintext&titles=${encodeURIComponent(titol)}&inprop=url&format=json&origin=*`;
            const r = await fetch(url);
            const d = await r.json();
            const p = Object.values(d.query.pages)[0];
            let text = p.extract ? p.extract.replace(/\n/g, ' ').trim() : "Sense resum.";
            if (text.length > 280) text = text.substring(0, 277) + "...";

            return { font: "BIOGRAFIA", nom: p.title, resum: text, link: p.fullurl, origen: "Viquip√®dia" };
        }

        function actualitzarTargeta(d) {
            const preview = document.getElementById('preview');
            preview.innerHTML = `
                <div class="bg-slate-900 p-6 rounded-xl border border-blue-500 shadow-xl">
                    <div class="text-blue-400 text-[10px] font-black tracking-widest uppercase mb-1">${d.font}</div>
                    <h2 class="text-2xl font-bold text-white">${d.nom}</h2>
                    <p class="text-slate-300 mt-4 text-sm leading-relaxed">${d.resum}</p>
                    <div class="text-slate-500 text-[10px] font-bold mt-4 border-t border-slate-800 pt-3">${d.origen}</div>
                </div>`;
        }

        function descarregarCSV() {
            let csv = "Font;Nom;Resum;Enlla√ß;Origen\n";
            resultats.forEach(p => {
                csv += `"${p.font}";"${p.nom}";"${p.resum.replace(/"/g, '""')}";"${p.link}";"${p.origen}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "biografies_completes_sitges.csv";
            link.click();
        }
    </script>
</body>
</html>
