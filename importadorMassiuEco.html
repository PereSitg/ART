<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>SITGESART - Importador Massiu (Protocol Rescat)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .log-box { background: #000; border: 1px solid #1e293b; height: 450px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; padding: 1rem; border-radius: 12px; color: #eab308; }
        .progress-bar { transition: width 0.5s ease; }
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold mb-2">üöÄ L'Eco <span class="text-yellow-500">Rescat</span></h1>
            <p class="text-slate-400 text-sm italic">Mode lent: Evita bloquejos de seguretat</p>
        </header>

        <div class="bg-slate-900 border border-slate-800 p-8 rounded-3xl shadow-2xl">
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">P√†gina d'inici</label>
                    <input type="number" id="pag-inici" value="15" class="w-full bg-black border border-slate-700 p-3 rounded-xl text-white font-bold">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Quantes p√†gines?</label>
                    <input type="number" id="total-pags" value="10" class="w-full bg-black border border-slate-700 p-3 rounded-xl text-white font-bold">
                </div>
            </div>

            <button onclick="iniciarImportacio()" id="btn-run" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-extrabold py-4 rounded-2xl transition-all mb-6">
                INICIAR IMPORTACI√ì DE SEGURETAT
            </button>

            <div class="flex justify-between items-center mb-2">
                <span id="status-text" class="text-xs font-bold text-slate-400 uppercase tracking-widest text-blue-400">Esperant...</span>
                <span id="percent-text" class="text-xs font-bold text-yellow-500">0%</span>
            </div>
            <div class="w-full bg-black h-3 rounded-full overflow-hidden border border-slate-800">
                <div id="bar" class="progress-bar bg-yellow-500 h-full w-0"></div>
            </div>

            <div class="log-box mt-6" id="log">
                <div>> Protocol de rescat preparat.</div>
                <div>> Utilitzant pausa de seguretat per evitar bloquejos de L'Eco.</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV8SrQ3tDiixCRwUDgC33jI8ZJzlcceZc",
            authDomain: "sitgesart.firebaseapp.com",
            projectId: "sitgesart",
            storageBucket: "sitgesart.firebasestorage.app",
            messagingSenderId: "673959867307",
            appId: "1:673959867307:web:80607c11d79db42b4918ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let guardatsGlobal = new Set();

        function normalitzarClau(text) {
            return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "").trim();
        }

        function log(msg, color = "#eab308") {
            const l = document.getElementById('log');
            l.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        window.iniciarImportacio = async () => {
            const inici = parseInt(document.getElementById('pag-inici').value);
            const quantitat = parseInt(document.getElementById('total-pags').value);
            const btn = document.getElementById('btn-run');
            
            btn.disabled = true;
            btn.classList.add('opacity-50');
            
            log("Sincronitzant Firebase...", "#fff");
            const snap = await getDocs(collection(db, "obres"));
            guardatsGlobal = new Set(snap.docs.map(d => normalitzarClau(d.data().nom)));
            log(`Protegides ${guardatsGlobal.size} obres existents.`);

            for (let i = 0; i < quantitat; i++) {
                let p = inici + i;
                document.getElementById('status-text').innerText = `LLEGINT P√ÄGINA ${p}...`;
                log(`Processant p√†gina ${p}...`, "#60a5fa");
                
                try {
                    const blogUrl = `https://lecodesitges.cat/category/cultura/feed/?paged=${p}`;
                    // Proxy AllOrigins amb marca de temps aleat√≤ria per evitar la mem√≤ria cau
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(blogUrl)}&cb=${Math.random()}`);
                    const data = await response.json();
                    
                    if (!data.contents) throw new Error("Contingut buit");

                    const xml = new DOMParser().parseFromString(data.contents, "text/xml");
                    const items = xml.querySelectorAll("item");

                    if (items.length === 0) {
                        log(`Av√≠s: P√†gina ${p} no cont√© articles. Reintentant en 10 segons...`, "#facc15");
                        await new Promise(r => setTimeout(r, 10000));
                        i--; // Tornem a provar la mateixa p√†gina
                        continue;
                    }

                    let nous = 0;
                    for (const item of items) {
                        const titol = item.querySelector("title").textContent;
                        const clau = normalitzarClau(titol);
                        const link = item.querySelector("link").textContent;
                        let resum = item.querySelector("description")?.textContent || "";
                        resum = resum.replace(/<[^>]*>?/gm, '').trim().substring(0, 160) + "...";

                        if (!guardatsGlobal.has(clau)) {
                            await addDoc(collection(db, "obres"), {
                                nom: titol,
                                resum: resum,
                                link: link,
                                font: "L'Eco de Sitges",
                                data_importacio: new Date().toISOString()
                            });
                            guardatsGlobal.add(clau);
                            nous++;
                            log(`GUARDAT: ${titol.substring(0,35)}...`, "#22c55e");
                        }
                    }

                    log(`P√†gina ${p} completada (+${nous} nous).`, "#94a3b8");

                    // Barra de progr√©s
                    const percent = Math.round(((i + 1) / quantitat) * 100);
                    document.getElementById('bar').style.width = percent + "%";
                    document.getElementById('percent-text').innerText = percent + "%";

                    // PAUSA DE SEGURETAT ENTRE P√ÄGINES (5 segons)
                    if (i < quantitat - 1) {
                        log("Pausa de seguretat de 5 segons...", "#475569");
                        await new Promise(r => setTimeout(r, 5000));
                    }

                } catch (e) {
                    log(`ERROR a la p√†gina ${p}. Reintentant en 20 segons...`, "#ef4444");
                    await new Promise(r => setTimeout(r, 20000));
                    i--; // No avancem, tornem a intentar la mateixa p√†gina
                }
            }

            log("--- IMPORTACI√ì FINALITZADA ---", "#22c55e");
            document.getElementById('status-text').innerText = "FINALITZAT";
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        };
    </script>
</body>
</html>
