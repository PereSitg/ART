<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>SITGESART - Importador Massiu L'Eco (Versi贸 Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #020617; 
            color: #f8fafc; 
            background-image: radial-gradient(at 0% 0%, rgba(234, 179, 8, 0.1) 0, transparent 50%);
        }
        .log-box { 
            background: #000; 
            border: 1px solid #1e293b; 
            height: 450px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 0.85rem; 
            padding: 1.5rem; 
            border-radius: 12px; 
            color: #eab308;
            line-height: 1.6;
        }
        .progress-bar { transition: width 0.5s ease-in-out; }
        input[type="number"] { outline: none; transition: 0.2s; }
        input[type="number"]:focus { border-color: #eab308; box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.2); }
    </style>
</head>
<body class="p-6 md:p-12">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold mb-3 tracking-tight"> L'Eco <span class="text-yellow-500">Massiu</span></h1>
            <p class="text-slate-400 text-lg">Sistema d'importaci贸 for莽ada per a l'arxiu hist貌ric de Cultura</p>
        </header>

        <div class="bg-slate-900/50 border border-slate-800 p-8 rounded-[2rem] backdrop-blur-xl shadow-2xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-3">Pgina d'inici (on et vas quedar)</label>
                    <input type="number" id="pag-inici" value="1" class="w-full bg-black border border-slate-700 p-4 rounded-2xl text-white text-lg font-bold">
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-3">Pgines a processar (recomanat: 10-20)</label>
                    <input type="number" id="total-pags" value="10" class="w-full bg-black border border-slate-700 p-4 rounded-2xl text-white text-lg font-bold">
                </div>
            </div>

            <button onclick="iniciarImportacio()" id="btn-run" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-5 rounded-2xl transition-all shadow-xl shadow-yellow-500/10 text-xl tracking-wide uppercase">
                Iniciar escaneig de seguretat
            </button>

            <div class="mt-10">
                <div class="flex justify-between text-xs font-bold mb-3 uppercase tracking-widest">
                    <span id="status-text" class="text-slate-400">Sistema en rep貌s...</span>
                    <span id="percent-text" class="text-yellow-500">0%</span>
                </div>
                <div class="w-full bg-black h-4 rounded-full p-1 border border-slate-800">
                    <div id="bar" class="progress-bar bg-yellow-500 h-full w-0 rounded-full"></div>
                </div>
            </div>

            <div class="log-box mt-8" id="log">
                <div>> Esperant ordres per iniciar la sincronitzaci贸...</div>
                <div>> Nota: Hem afegit una pausa de 3s per evitar bloquejos.</div>
            </div>
        </div>

        <footer class="mt-8 text-center text-slate-500 text-sm">
            SitgesArt Engine v2.5 | Filtrage d'accents i duplicats actiu
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV8SrQ3tDiixCRwUDgC33jI8ZJzlcceZc",
            authDomain: "sitgesart.firebaseapp.com",
            projectId: "sitgesart",
            storageBucket: "sitgesart.firebasestorage.app",
            messagingSenderId: "673959867307",
            appId: "1:673959867307:web:80607c11d79db42b4918ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let guardatsGlobal = new Set();

        function normalitzarClau(text) {
            return text.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9]/g, "")
                .trim();
        }

        function log(msg, color = "#eab308") {
            const l = document.getElementById('log');
            l.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        window.iniciarImportacio = async () => {
            const inici = parseInt(document.getElementById('pag-inici').value);
            const quantitat = parseInt(document.getElementById('total-pags').value);
            const btn = document.getElementById('btn-run');
            
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            log("Sincronitzant mem貌ria amb Firebase...", "#fff");

            // 1. Carregar tot el que ja tenim per blindar contra duplicats
            try {
                const snap = await getDocs(collection(db, "obres"));
                guardatsGlobal = new Set(snap.docs.map(d => normalitzarClau(d.data().nom)));
                log(`Base de dades sincronitzada. Tenim ${guardatsGlobal.size} obres protegides.`);
            } catch(err) {
                log("Error connectant a Firebase. Revisa la xarxa.", "#ef4444");
                btn.disabled = false;
                return;
            }

            // 2. Bucle principal
            for (let i = 0; i < quantitat; i++) {
                let p = inici + i;
                log(`Sol路licitant pgina ${p} a L'Eco...`, "#60a5fa");
                
                try {
                    const blogUrl = `https://lecodesitges.cat/category/cultura/feed/?paged=${p}`;
                    // Proxy AllOrigins per major estabilitat amb pells de dades
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(blogUrl)}&ts=${Date.now()}`);
                    const data = await response.json();
                    
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(data.contents, "text/xml");
                    const items = xml.querySelectorAll("item");

                    if (!items || items.length === 0) {
                        log(`La pgina ${p} no ha retornat articles. Fi de l'arxiu?`, "#facc15");
                        break;
                    }

                    let nous = 0;
                    for (const item of items) {
                        const titol = item.querySelector("title").textContent;
                        const clau = normalitzarClau(titol);
                        const link = item.querySelector("link").textContent;
                        let resum = item.querySelector("description")?.textContent || "";
                        resum = resum.replace(/<[^>]*>?/gm, '').trim().substring(0, 160) + "...";

                        if (!guardatsGlobal.has(clau)) {
                            await addDoc(collection(db, "obres"), {
                                nom: titol,
                                resum: resum,
                                link: link,
                                font: "L'Eco de Sitges",
                                data_importacio: new Date().toISOString()
                            });
                            guardatsGlobal.add(clau);
                            nous++;
                            log(`GRVAT: ${titol.substring(0,45)}...`, "#22c55e");
                        }
                    }

                    log(`Pgina ${p} processada correctament. Nous: ${nous}`, "#94a3b8");

                } catch (e) {
                    log(`Error cr铆tic a la pgina ${p}. El servidor ha tallat el flux.`, "#ef4444");
                    log("Aturant el proc茅s 10 segons per seguretat...", "#ef4444");
                    await new Promise(r => setTimeout(r, 10000));
                }

                // Actualitzaci贸 visual de la barra
                const percent = Math.round(((i + 1) / quantitat) * 100);
                document.getElementById('bar').style.width = percent + "%";
                document.getElementById('percent-text').innerText = percent + "%";
                document.getElementById('status-text').innerText = `Processant: ${p} de ${inici + quantitat - 1}`;
                
                // PAUSA DE SEGURETAT (3 segons) per no ser detectats com a bot
                await new Promise(r => setTimeout(r, 3000));
            }

            log("--- TOTS ELS BLOCS PROCESSATS ---", "#22c55e");
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('status-text').innerText = "Tasques completades.";
        };
    </script>
</body>
</html>
