<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>SITGESART - Importador Massiu L'Eco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .log-box { background: #000; border: 1px solid #1e293b; height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; padding: 1rem; border-radius: 12px; color: #eab308; }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="p-10">

    <div class="max-w-3xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold mb-2">ðŸš€ Importador <span class="text-yellow-500">Massiu</span></h1>
            <p class="text-slate-400">Escaneig automÃ tic de l'arxiu de Cultura de L'Eco</p>
        </header>

        <div class="bg-slate-900 border border-slate-800 p-8 rounded-3xl shadow-2xl">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">PÃ gina d'inici</label>
                    <input type="number" id="pag-inici" value="1" class="w-full bg-black border border-slate-700 p-3 rounded-xl text-white">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Quantes pÃ gines escanejar?</label>
                    <input type="number" id="total-pags" value="5" class="w-full bg-black border border-slate-700 p-3 rounded-xl text-white">
                </div>
            </div>

            <button onclick="iniciarImportacio()" id="btn-run" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-extrabold py-4 rounded-2xl transition-all shadow-lg shadow-yellow-500/20">
                INICIAR ESCANEIG I IMPORTACIÃ“
            </button>

            <div class="mt-8">
                <div class="flex justify-between text-xs mb-2">
                    <span id="status-text">Esperant ordres...</span>
                    <span id="percent-text">0%</span>
                </div>
                <div class="w-full bg-black h-3 rounded-full overflow-hidden">
                    <div id="bar" class="progress-bar bg-yellow-500 h-full w-0"></div>
                </div>
            </div>

            <div class="log-box mt-6" id="log"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV8SrQ3tDiixCRwUDgC33jI8ZJzlcceZc",
            authDomain: "sitgesart.firebaseapp.com",
            projectId: "sitgesart",
            storageBucket: "sitgesart.firebasestorage.app",
            messagingSenderId: "673959867307",
            appId: "1:673959867307:web:80607c11d79db42b4918ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let guardatsGlobal = new Set();

        function normalitzarClau(text) {
            return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "").trim();
        }

        function log(msg, color = "#eab308") {
            const l = document.getElementById('log');
            l.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        window.iniciarImportacio = async () => {
            const inici = parseInt(document.getElementById('pag-inici').value);
            const quantitat = parseInt(document.getElementById('total-pags').value);
            const btn = document.getElementById('btn-run');
            
            btn.disabled = true;
            btn.style.opacity = 0.5;
            log("Sincronitzant amb Firebase per evitar duplicats...", "#fff");

            // 1. Carregar tot el que ja tenim
            const snap = await getDocs(collection(db, "obres"));
            guardatsGlobal = new Set(snap.docs.map(d => normalitzarClau(d.data().nom)));
            log(`S'han trobat ${guardatsGlobal.size} obres ja existents a la web.`);

            // 2. Bucle de pÃ gines
            for (let i = 0; i < quantitat; i++) {
                let p = inici + i;
                log(`Processant pÃ gina ${p}...`, "#60a5fa");
                
                try {
                    const blogUrl = `https://lecodesitges.cat/category/cultura/feed/?paged=${p}`;
                    const response = await fetch(`https://api.codetabs.com/v1/proxy/?quest=${encodeURIComponent(blogUrl)}`);
                    const xmlText = await response.text();
                    const xml = new DOMParser().parseFromString(xmlText, "text/xml");
                    const items = xml.querySelectorAll("item");

                    if (items.length === 0) {
                        log("No hi ha mÃ©s dades. Finalitzant.");
                        break;
                    }

                    for (const item of items) {
                        const titol = item.querySelector("title").textContent;
                        const clau = normalitzarClau(titol);
                        const link = item.querySelector("link").textContent;
                        let resum = item.querySelector("description")?.textContent || "";
                        resum = resum.replace(/<[^>]*>?/gm, '').trim().substring(0, 160) + "...";

                        if (!guardatsGlobal.has(clau)) {
                            // IMPORTAR SI NO EXISTEIX
                            await addDoc(collection(db, "obres"), {
                                nom: titol,
                                resum: resum,
                                link: link,
                                font: "L'Eco de Sitges",
                                data_importacio: new Date().toISOString()
                            });
                            guardatsGlobal.add(clau); // Afegim a la memÃ²ria per no repetir en el mateix bucle
                            log(`IMPORTAT: ${titol}`, "#22c55e");
                        } else {
                            log(`SALTAT (Duplicat): ${titol.substring(0,30)}...`, "#64748b");
                        }
                    }

                    // Actualitzar barra de progrÃ©s
                    const percent = Math.round(((i + 1) / quantitat) * 100);
                    document.getElementById('bar').style.width = percent + "%";
                    document.getElementById('percent-text').innerText = percent + "%";
                    document.getElementById('status-text').innerText = `PÃ gina ${p} completada...`;

                } catch (e) {
                    log(`Error a la pÃ gina ${p}. Saltant...`, "#ef4444");
                }
                
                // Petita pausa per no saturar el servidor
                await new Promise(r => setTimeout(r, 1000));
            }

            log("--- PROCÃ‰S FINALITZAT ---", "#22c55e");
            btn.disabled = false;
            btn.style.opacity = 1;
        };
    </script>
</body>
</html>
