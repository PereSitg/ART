<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>SitgesArt - Importador de 341 Notícies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="p-10">
    <div class="max-w-2xl mx-auto bg-slate-900 p-8 rounded-3xl border border-slate-800 shadow-2xl">
        <h1 class="text-3xl font-extrabold text-blue-500 mb-2">Importador Oficial</h1>
        <p class="text-slate-400 mb-8">Pujant 341 notícies de l'Ajuntament de Sitges a Firebase.</p>

        <div class="mb-6">
            <label class="block text-sm font-bold mb-2">Selecciona el fitxer JSON:</label>
            <input type="file" id="jsonInput" accept=".json" class="w-full bg-black p-4 rounded-xl border border-slate-700">
        </div>

        <button onclick="iniciarImportacio()" id="btnPujar" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-lg transition-all">
            INICIAR PUJADA MASSIVA
        </button>

        <div id="status-box" class="hidden mt-8">
            <div class="flex justify-between mb-2 text-sm">
                <span id="txtProgres">Processant...</span>
                <span id="percentatge">0%</span>
            </div>
            <div class="w-full bg-slate-800 rounded-full h-4 overflow-hidden">
                <div id="barra" class="progress-bar bg-blue-500 h-full w-0"></div>
            </div>
            <div id="log" class="mt-4 text-xs font-mono text-slate-500 h-32 overflow-y-auto bg-black p-4 rounded-lg">
                > Esperant fitxer...
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV8SrQ3tDiixCRwUDgC33jI8ZJzlcceZc",
            authDomain: "sitgesart.firebaseapp.com",
            projectId: "sitgesart",
            storageBucket: "sitgesart.firebasestorage.app",
            messagingSenderId: "673959867307",
            appId: "1:673959867307:web:80607c11d79db42b4918ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.iniciarImportacio = async () => {
            const input = document.getElementById('jsonInput');
            if (!input.files[0]) return alert("Selecciona el fitxer JSON primer!");

            const btn = document.getElementById('btnPujar');
            const statusBox = document.getElementById('status-box');
            const log = document.getElementById('log');
            const barra = document.getElementById('barra');
            const txtProgres = document.getElementById('txtProgres');
            const percent = document.getElementById('percentatge');

            btn.disabled = true;
            statusBox.classList.remove('hidden');

            // 1. Carregar dades existents per evitar duplicats
            log.innerHTML += "<div>> Sincronitzant amb Firebase per evitar duplicats...</div>";
            const snap = await getDocs(collection(db, "obres"));
            const guardats = new Set(snap.docs.map(d => d.data().nom.toLowerCase().trim()));

            const reader = new FileReader();
            reader.onload = async (e) => {
                const dades = JSON.parse(e.target.result);
                const total = dades.length;
                let nous = 0;
                let processats = 0;

                for (const item of dades) {
                    processats++;
                    const nomNet = item.nom.toLowerCase().trim();

                    if (!guardats.has(nomNet)) {
                        try {
                            // Assegurem que el model sigui el correcte
                            await addDoc(collection(db, "obres"), {
                                nom: item.nom,
                                resum: item.resum || "",
                                link: item.link || "",
                                font: "Ajuntament de Sitges",
                                origen: "Cultura Sitges",
                                data_importacio: new Date().toISOString()
                            });
                            nous++;
                            log.innerHTML += `<div class="text-blue-400">> Importat: ${item.nom.substring(0,40)}...</div>`;
                        } catch (err) {
                            log.innerHTML += `<div class="text-red-500">> Error en: ${item.nom}</div>`;
                        }
                    } else {
                        log.innerHTML += `<div class="text-slate-600">> Saltat (ja existeix): ${item.nom.substring(0,30)}...</div>`;
                    }

                    // Actualitzar barra
                    const p = Math.round((processats / total) * 100);
                    barra.style.width = p + "%";
                    percent.innerText = p + "%";
                    txtProgres.innerText = `Processant ${processats} de ${total}...`;
                    log.scrollTop = log.scrollHeight;
                }

                log.innerHTML += `<div class="text-green-500 font-bold mt-2">✅ FINALITZAT! S'han afegit ${nous} notícies noves.</div>`;
                btn.innerText = "IMPORTACIÓ COMPLETADA";
            };
            reader.readAsText(input.files[0]);
        };
    </script>
</body>
</html>
