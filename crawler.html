<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>SitgesArt - RecuperaciÃ³ de Dades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Plus Jakarta Sans', sans-serif; }</style>
</head>
<body class="bg-slate-50 p-6">
    <div class="max-w-4xl mx-auto">
        <div id="auth-box" class="text-right mb-4">
            <button onclick="loginGoogle()" class="text-xs font-bold text-blue-600 underline">Admin Login</button>
        </div>

        <div class="bg-white p-10 rounded-3xl shadow-xl border border-slate-100 text-center">
            <h1 class="text-2xl font-black mb-6">Rastrejador SitgesArt</h1>
            
            <button onclick="executarCerca()" id="btn-cerca" class="bg-orange-500 text-white px-10 py-5 rounded-2xl font-black text-xl hover:scale-105 transition-all shadow-lg">
                ðŸš€ BUSCAR ENTRADES ARA
            </button>

            <div id="status-area" class="mt-8 text-left border-t pt-6 hidden">
                <div class="flex items-center gap-3 mb-4">
                    <div id="spinner" class="animate-spin h-5 w-5 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                    <span id="status-text" class="font-bold text-slate-600 uppercase text-xs tracking-widest">Iniciant...</span>
                </div>
                <div id="log-console" class="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-[10px] h-32 overflow-y-auto shadow-inner">
                    > Esperant ordres...
                </div>
            </div>
        </div>

        <div id="resultats" class="grid gap-4 mt-10"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV8SrQ3tDiixCRwUDgC33jI8ZJzlcceZc",
            authDomain: "sitgesart.firebaseapp.com",
            projectId: "sitgesart",
            storageBucket: "sitgesart.firebasestorage.app",
            messagingSenderId: "673959867307",
            appId: "1:673959867307:web:80607c11d79db42b4918ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.loginGoogle = () => signInWithPopup(auth, provider);

        function log(msg, color = "") {
            const console = document.getElementById('log-console');
            console.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        window.executarCerca = async () => {
            const btn = document.getElementById('btn-cerca');
            const statusArea = document.getElementById('status-area');
            const statusText = document.getElementById('status-text');
            const resBox = document.getElementById('resultats');
            
            btn.disabled = true;
            statusArea.classList.remove('hidden');
            resBox.innerHTML = "";
            log("--- INICIANT ESCANEIG ---");

            // 1. INTENTAR LLEGIR FIREBASE AMB TEMPS LÃMIT
            log("Pas 1: Verificant connexiÃ³ amb Firebase...");
            statusText.innerText = "Connectant amb la base de dades...";
            
            let guardats = [];
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                log("âš ï¸ ALERTA: Firebase no respon en 5s. Continuem nomÃ©s amb el Blog.", "text-orange-400");
                controller.abort();
            }, 5000);

            try {
                const snap = await getDocs(collection(db, "obres"));
                clearTimeout(timeoutId);
                guardats = snap.docs.map(d => d.data().link);
                log(`âœ… Firebase OK. Trobat: ${guardats.length} obres.`, "text-blue-400");
            } catch (e) {
                log("âš ï¸ Ignorant base de dades (possible bloqueig de seguretat).", "text-red-400");
            }

            // 2. LLEGIR EL BLOG (Aquest pas no sol fallar si tens internet)
            log("Pas 2: Descarregant dades de 'Retalls de Sitges'...");
            statusText.innerText = "Llegint entrades del blog...";

            try {
                const blogUrl = "https://retallsdesitges.blogspot.com/feeds/posts/default?alt=rss&max-results=500";
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(blogUrl)}`);
                const data = await response.json();
                const xml = new DOMParser().parseFromString(data.contents, "text/xml");
                const items = xml.querySelectorAll("item");

                log(`âœ… Blog OK. Processant ${items.length} entrades...`, "text-blue-400");
                statusText.innerText = "Finalitzant...";

                items.forEach((item, i) => {
                    const titol = item.querySelector("title").textContent;
                    const link = item.querySelector("link").textContent;
                    const jaExisteix = guardats.includes(link);

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl border flex justify-between items-center ${jaExisteix ? 'bg-slate-100 opacity-40' : 'bg-white shadow-sm'}`;
                    div.innerHTML = `
                        <div class="max-w-[80%]">
                            <h4 class="font-bold text-sm text-slate-800">${titol}</h4>
                            <p class="text-[10px] text-slate-400">${link}</p>
                        </div>
                        ${jaExisteix ? '<span class="text-[8px] font-black opacity-50">DINS</span>' : `<button onclick="importar(this, ${i})" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold">IMPORTAR</button>`}
                    `;
                    div.dataset.info = JSON.stringify({ nom: titol, link: link, font: "Retalls de Sitges", data: new Date() });
                    resBox.appendChild(div);
                });
                
                log("--- PROCÃ‰S ACABAT ---", "text-green-400");
                document.getElementById('spinner').classList.add('hidden');
                statusText.innerText = "Llista preparada";

            } catch (e) {
                log("âŒ ERROR CRÃTIC: No s'ha pogut llegir el blog.", "text-red-500");
            } finally {
                btn.disabled = false;
            }
        };

        window.importar = async (btn, i) => {
            const data = JSON.parse(btn.closest('div').dataset.info);
            btn.innerText = "...";
            try {
                await addDoc(collection(db, "obres"), data);
                btn.innerText = "âœ…";
                btn.disabled = true;
                log(`Importat: ${data.nom}`, "text-green-400");
            } catch (err) {
                alert("Error de permisos.");
            }
        };
    </script>
</body>
</html>
