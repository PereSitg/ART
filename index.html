<script>
    let dades = [];

    // Intentem carregar el fitxer amb un missatge d'error si falla
    fetch('biblioteca_sitges_premium.json')
        .then(response => {
            if (!response.ok) throw new Error("No s'ha pogut carregar el JSON");
            return response.json();
        })
        .then(data => {
            dades = data;
            console.log("Dades carregades correctament:", dades.length, "entitats");
            renderitzar(dades); // Mostra-ho tot al principi
        })
        .catch(error => {
            console.error("Error criticitat:", error);
            document.getElementById('resultats').innerHTML = 
                `<p style="color:red">Error: No s'han pogut carregar les dades. 
                Assegura't que el fitxer 'biblioteca_sitges_premium.json' √©s a la mateixa carpeta.</p>`;
        });

    const buscador = document.getElementById('buscador');
    const resultatsDiv = document.getElementById('resultats');

    buscador.addEventListener('input', () => {
        const query = buscador.value.toLowerCase().trim();
        
        // Si el buscador est√† buit, tornem a mostrar-ho tot
        if (query === "") {
            renderitzar(dades);
            return;
        }

        const filtrats = dades.filter(d => 
            (d.nom && d.nom.toLowerCase().includes(query)) || 
            (d.resum && d.resum.toLowerCase().includes(query))
        );
        renderitzar(filtrats);
    });

    function renderitzar(llista) {
        resultatsDiv.innerHTML = llista.length > 0 ? "" : "<p style='text-align:center'>No s'han trobat resultats.</p>";
        llista.forEach(item => {
            let obresHTML = "";
            if(item.analisis_obres) {
                item.analisis_obres.forEach(o => {
                    obresHTML += `
                        <div class="obra-box">
                            <span class="obra-titol">üñºÔ∏è ${o.titol}</span>
                            <small>${o.explicacio_artistica || 'Sense descripci√≥ disponible.'}</small>
                        </div>`;
                });
            }

            resultatsDiv.innerHTML += `
                <div class="card">
                    <span class="tag">${item.tipus || 'Cultura'}</span>
                    <h2>${item.nom}</h2>
                    <p>${item.resum}</p>
                    <div>${obresHTML}</div>
                    <p style="margin-top:20px"><a href="${item.url}" target="_blank">Llegir biografia completa &rarr;</a></p>
                </div>
            `;
        });
    }
</script>